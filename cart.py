from re import S, X
from cachelib import SimpleCache
from linebot.models import *
from sqlalchemy.orm import lazyload
from sqlalchemy.sql.expression import true
from database import db_session
from menuproduct import Menuproducts
from urllib.parse import quote #‰ΩøÁî®ËÄÖËá™ÂãïËº∏ÂÖ•Â∞àÁî®ÔºåÂèØÈÅøÂÖçÁ©∫ÁôΩËº∏ÂÖ•
from config import Config
#Âª∫Á´ãÈ°ûÂà•Ë®≠ÂÆöÁµ¶cart
cache = SimpleCache()

class Cart(object):
    def __init__(self,user_id):
        self.cache = cache
        self.user_id = user_id
    def bucket(self):
        
        #ÈÄèÈÅéuser_idÊü•Ë©¢‰ΩøÁî®ËÄÖÁöÑË≥ºÁâ©ËªäÂ¶ÇÊûúÊ≤íÊúâÊù±Ë•øÂ∞±ÊúÉÂõûÂÇ≥Á©∫ÂÄº
        return cache.get(key=self.user_id) or {}
    def add(self,forma_t,num=1):
        bucket = self.bucket()
        bucket =cache.get(key=self.user_id)#ÈÄèÈÅéuser_idÂèñÂæó‰ΩøÁî®ËÄÖÁöÑË≥ºÁâ©Ëªä
        #Â¶ÇÊûúË≥ºÁâ©ËªäÊòØÁ©∫ÁöÑÂ∞±ÊúÉÂä†ÂÖ•‰∏ÄÂÄãÂ≠óÂÖ∏ product:int(num)
        if bucket == None :
            cache.add(key=self.user_id,value={forma_t:int(num)})
        else:
            #Â¶ÇË≥ºÁâ©ËªäÂÖ∂‰ªñÂïÜÂìÅÂ∞±ÊúÉÊõ¥Êñ∞‰∏ÄÂÄãÂ≠óÂÖ∏ product:int(num)
            bucket.update({forma_t:int(num)})
            #Êé•ËëóÂÜçÊõ¥Êñ∞Âà∞‰ΩøÁî®ËÄÖÁöÑË≥ºÁâ©Ëªä
            cache.set(key=self.user_id,value=bucket)
    def reset(self):#Ê∏ÖÁ©∫Ë≥ºÁâ©Ëªä
        cache.set(key=self.user_id,value={})

    def display(self):#Ë®àÁÆóË≥ºÁâ©ËªäÂÖßÂÆπÂèäÂÉπÊ†º
        total = 0#Á∏ΩÈáëÈ°ç
        total_number = 0#Á∏ΩÂÖ±È†ÖÁõÆ
        product_box_component = []#ÊîæÁΩÆÁî¢ÂìÅÊòéÁ¥∞
        for product_name, num in self.bucket().items():#ÈÄèÈÅéforËø¥ÂúàÊäìÂèñË≥ºÁâ©ËªäÂÖßÂÆπ
            if num > 0 :
            #ÈÄèÈÅé Menuproducts.forma_t ÂéªÊêúÂ∞ã
                forma_t = db_session.query(Menuproducts).filter(Menuproducts.forma_t.ilike(product_name)).first()
                amount = forma_t.price * int(num)#ÁÑ∂ÂæåÂÜç‰πò‰ª•Ë≥ºË≤∑ÁöÑÊï∏Èáè
                product = forma_t.product
                total += amount
                total_number += 1
                product_box_component.append(
                    {
                    "type": "box",
                    "layout": "vertical",
                    "contents": [
                    {
                        "type": "text",
                        "text": 'NT$ {amount}'.format(amount=amount),
                        "weight": "bold",
                        "size": "sm",
                        "color": "#CACACA"
                    },
                    {
                        "type": "text",
                        "text": product,
                        "color": "#86340A",
                        "size": "lg",
                        "weight": "bold"
                    },
                    {
                        "type": "text",
                        "text": 'Ë¶èÊ†ºÔºö{forma_t}'.format(forma_t=product_name),
                        "color": "#4D4D4D",
                        "size": "md"
                    },
                    {
                        "type": "text",
                        "text": "Êï∏ÈáèÔºö{number}".format(number=num),
                        "size": "md",
                        "color": "#4D4D4D"
                    },
                    {
                        "type": "box",
                        "layout": "horizontal",
                        "contents": [
                        {
                            "type": "box",
                            "layout": "vertical",
                            "contents": [
                            {
                                "type": "text",
                                "text": "Êï∏ÈáèÈÅ∏Êìá",
                                "size": "10px",
                                "align": "end",
                                "action": {
                                "type": "postback",
                                "label": "number",
                                "data": 'Êõ¥ÊîπÊï∏Èáè{product_name}'.format(product_name=product_name)
                                }
                            }
                            ],
                            "flex": 5
                        },
                        {
                            "type": "box",
                            "layout": "horizontal",
                            "contents": [
                            {
                                "type": "image",
                                "url": "https://i.imgur.com/nrLi1g0.png",
                                "size": "15px",
                                "flex": 5,
                                "action": {
                                "type": "postback",
                                "label": "number",
                                "data": 'Êõ¥ÊîπÊï∏Èáè{product_name}'.format(product_name=product_name)
                                }
                            },
                            {
                                "type": "image",
                                "url": "https://i.imgur.com/GfZEGJw.png",
                                "size": "15px",
                                "flex": 5,
                                "action": {
                                "type": "postback",
                                "label": "number",
                                "data": 'Êõ¥ÊîπÊï∏Èáè{product_name}'.format(product_name=product_name)
                                }
                            }
                            ],
                            "flex": 1,
                            "action": {
                            "type": "postback",
                            "label": "number",
                            "data": "number"
                            }
                        },
                        {
                            "type": "box",
                            "layout": "vertical",
                            "contents": [
                            {
                                "type": "image",
                                "url": "https://i.imgur.com/eSBgsbP.png",
                                "size": "20px",
                                "action": {
                                "type": "postback",
                                "label": "delete",
                                "data": 'Âà™Èô§{product_name}'.format(product_name=product_name)
                                }
                            }
                            ],
                            "alignItems": "flex-end",
                            "flex": 2,
                            "action": {
                            "type": "postback",
                            "label": "delete",
                            "data": "delete"
                            }
                        }
                        ],
                        "paddingBottom": "10px"
                    }
                    ]
                })
        if total > 0:
            message = FlexSendMessage(
                alt_text='Ë≥ºÁâ©Ëªä',
                contents={
                    "type": "bubble",
                    "body": {
                        "type": "box",
                        "layout": "vertical",
                        "contents": [
                        {
                            "type": "text",
                            "text": "Ë≥ºÁâ©Ëªä  üõí",
                            "weight": "bold",
                            "margin": "md",
                            "size": "xxl",
                            "color": "#4493A3"
                        },
                        {
                            "type": "separator",
                            "margin": "sm"
                        },
                        {
                            "type": "text",
                            "text": "Á∏ΩÂÖ±È†ÖÁõÆÔºö{total_number}".format(total_number=total_number),
                            "size": "sm",
                            "align": "end",
                            "color": "#000000"
                        },
                        {
                            "type":"box",
                            "layout": "vertical",
                            "margin":'xxl',
                            "spacing":'sm',
                            "contents":product_box_component   
                        },
                        {
                            "type": "separator",
                            "margin": "sm"
                        },
                        {
                            "type": "box",
                            "layout": "horizontal",
                            "margin": "md",
                            "contents": []
                        },
                        {
                            "type": "text",
                            "text": 'Á∏ΩÂÖ±ÔºöNT${total}'.format(total=total),
                            "align": "end",
                            "color": "#4D4D4D",
                            "size": "md"
                        },
                        {
                            "type": "box",
                            "layout": "horizontal",
                            "contents": [
                            {   "type": "button",
                                "action": {
                                "type": "postback",
                                "label": "ÁµêÂ∏≥",
                                "data": "ÁµêÂ∏≥"
                                },
                                "color": "#C36839",
                                "style": "primary",
                                "flex": 4,
                                "margin": "none"
                            },
                            {
                                "type": "button",
                                "action": {
                                "type": "postback",
                                "label": "ÁπºÁ∫åÈÅ∏Ë≥º",
                                "data": "ÁπºÁ∫åÈÅ∏Ë≥º"
                                },
                                "color": "#7EB5A6",
                                "style": "primary",
                                "flex": 4
                                
                            }
                            ],
                            "offsetTop": "2px",
                            "spacing": "md"
                        }
                        ]}})
        else:
            message = TextSendMessage(text='ÊÇ®ÁöÑË≥ºÁâ©ËªäÊòØÁ©∫ÁöÑ„ÄÇ')
        return message
    def change_number(self,name='ËóçËâ≤ BLUE'):
        # for product_name, num in self.bucket().items():#ÈÄèÈÅéforËø¥ÂúàÊäìÂèñË≥ºÁâ©ËªäÂÖßÂÆπ
            #ÈÄèÈÅé Menuproducts.forma_t ÂéªÊêúÂ∞ã
        forma_t = db_session.query(Menuproducts).filter(Menuproducts.forma_t.ilike(name)).first()
        message = FlexSendMessage(
                    alt_text='Êï∏ÈáèÊõ¥Êîπ',
                    contents={
                        "type": "bubble",
                        "size": "kilo",
                        "body": {
                            "type": "box",
                            "layout": "vertical",
                            "contents": [
                            {
                                "type": "text",
                                "text": "{format_}".format(format_=forma_t.forma_t),
                                "weight": "bold",
                                "size": "20px",
                                "margin": "md",
                                "offsetBottom": "10px"
                            },
                            {
                                "type": "text",
                                "text": "Ë´ãÈÅ∏ÊìáÊï∏Èáè:",
                                "size": "xs",
                                "color": "#aaaaaa",
                                
                                "offsetBottom": "10px"
                            },
                            {
                                "type": "separator",
                                "margin": "xs"
                            },
                            {
                                "type": "box",
                                "layout": "vertical",
                                "margin": "xs",
                                "contents": [
                                {
                                    "type": "button",
                                    "action": {
                                    "type": "postback",
                                    "label": "1",
                                    "data": 'Êï∏Èáè1{forma_t}'.format(forma_t=forma_t.forma_t)
                                    },
                                    "margin": "xs",
                                    "height": "sm"
                                },
                                {
                                "type": "button",
                                    "action": {
                                    "type": "postback",
                                    "label": "2",
                                    "data": 'Êï∏Èáè2{forma_t}'.format(forma_t=forma_t.forma_t)
                                    },
                                    "margin": "xs",
                                    "height": "sm"
                                },
                                {
                                    "type": "button",
                                    "action": {
                                    "type": "postback",
                                    "label": "3",
                                    "data": 'Êï∏Èáè3{forma_t}'.format(forma_t=forma_t.forma_t)
                                    },
                                    "margin": "xs",
                                    "height": "sm"
                                },
                                {
                                    "type": "button",
                                    "action": {
                                    "type": "uri",
                                    "label": "ÂÖ∂‰ªñÊï∏Èáè",
                                    "uri": 'line://oaMessage/{base_id}/?{message}'.format(base_id=Config.BASE_ID,message=quote('{forma_t},Ëº∏ÂÖ•Êï∏ÈáèÔºö'.format(forma_t=forma_t.forma_t)))
                                    },
                                    "margin": "xs",
                                    "height": "sm",
                                    "style": "primary",
                                    "color": "#C36839"
                                }
                                ],
                                "spacing": "xs"
                            }
                            ]
                        }
                })
        return message
cart = Cart(user_id='10')#Êà¥ÂÖ•user_idÊâçÁü•ÈÅìË≥ºÁâ©ËªäÊòØË™∞ÁöÑ
cart.bucket()#Êü•Ë©¢Ë≥ºÁâ©ËªäÁöÑÂÖßÂÆπÂèØ‰ª•Áî®bucket()
cart.add('S98M',2)#Âà©Áî®addÂä†ÂÖ•ÂÖ©ÊùØÂíñÂï°
cart.reset()#Ê∏ÖÈô§Ë≥ºÁâ©Ëªä